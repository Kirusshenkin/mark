# 🤖 Crypto Trading Bot - DCA + Auto-Sell

Полнофункциональный Telegram-бот для криптотрейдинга с поддержкой стратегий DCA (Dollar Cost Averaging) и Auto-Sell, интегрированный с AI-ассистентом, биржей Bybit и PostgreSQL.

## 🎯 Основные возможности

### 📈 DCA (Dollar Cost Averaging)
- Автоматическая покупка криптовалюты по расписанию
- Настраиваемая сумма покупки и интервал
- Расчет средней цены входа
- Отслеживание инвестированной суммы

### 💰 Auto-Sell
- Автоматическая фиксация прибыли при достижении целевого процента
- Настраиваемый процент триггера и объем продажи
- Возможность включения/выключения
- Отслеживание реализованной прибыли

### 🧠 AI-ассистент
- Обработка команд на естественном языке
- Интеграция с Qwen/Kimi или другими LLM
- Анализ рыночной ситуации
- Интеллектуальные рекомендации

### 📲 Telegram Bot
- Полное управление через Telegram
- Команды и естественный язык
- Уведомления о сделках
- Просмотр статуса и истории

### 🔄 Интеграция с Bybit
- Spot API v5
- Получение цен и балансов
- Размещение рыночных ордеров
- Проверка статуса ордеров

### 🗄️ PostgreSQL
- Хранение истории сделок
- Отслеживание балансов
- Динамическая конфигурация
- Логирование событий

## 🏗️ Архитектура

```
┌────────────────────────┐
│   Telegram Bot         │ ← Интерфейс пользователя
└───────────┬────────────┘
            │
┌───────────▼────────────┐
│   AI Layer             │ ← Обработка NLP и анализ
└───────────┬────────────┘
            │
┌───────────▼────────────┐
│   Strategy Layer       │ ← DCA + Auto-Sell логика
└───────────┬────────────┘
            │
┌───────────▼────────────┐
│   Bybit API v5         │ ← Торговые операции
└───────────┬────────────┘
            │
┌───────────▼────────────┐
│   PostgreSQL           │ ← Хранение данных
└────────────────────────┘
```

## 📁 Структура проекта

```
.
├── cmd/
│   └── bot/
│       └── main.go              # Точка входа
├── internal/
│   ├── config/
│   │   └── config.go            # Конфигурация
│   ├── exchange/
│   │   └── bybit.go             # Bybit API клиент
│   ├── strategy/
│   │   ├── dca.go               # DCA стратегия
│   │   └── autosell.go          # Auto-Sell стратегия
│   ├── telegram/
│   │   └── bot.go               # Telegram бот
│   ├── ai/
│   │   └── client.go            # AI интеграция
│   └── storage/
│       ├── models.go            # Модели данных
│       └── postgres.go          # PostgreSQL клиент
├── pkg/
│   └── utils/
│       └── logger.go            # Логирование
├── .env.example                 # Пример конфигурации
├── go.mod
└── README.md
```

## 🚀 Быстрый старт

**Рекомендуемый способ - Docker Compose (всё в одной команде!):**

### Запуск через Docker Compose (рекомендуется)

```bash
# 1. Клонируйте репозиторий
git clone <your-repo>
cd crypto-trading-bot

# 2. Создайте .env файл
cp .env.example .env
# Отредактируйте .env и заполните обязательные параметры

# 3. Запустите всё одной командой
docker-compose up -d

# 4. Проверьте логи
docker-compose logs -f bot
```

**Готово!** PostgreSQL и бот автоматически настроены и запущены.

📖 Подробная инструкция: [QUICKSTART.md](QUICKSTART.md)

---

### Альтернативный способ - Ручная установка

<details>
<summary>Нажмите, чтобы развернуть</summary>

#### 1. Требования

- Go 1.24+
- PostgreSQL 12+
- Telegram Bot Token
- Bybit API ключи
- (Опционально) AI API ключи (Qwen/Kimi)

#### 2. Установка

```bash
# Клонируем репозиторий
git clone <your-repo>
cd crypto-trading-bot

# Устанавливаем зависимости
go mod download
```

#### 3. Настройка базы данных

```bash
# Создаем базу данных
createdb crypto_trading_bot

# Миграции выполнятся автоматически при первом запуске
```

#### 4. Конфигурация

Создайте `.env` файл на основе `.env.example`:

```bash
cp .env.example .env
```

Заполните следующие обязательные параметры:

```env
# Telegram
TELEGRAM_BOT_TOKEN=your_bot_token
TELEGRAM_CHAT_ID=your_chat_id

# Bybit
BYBIT_API_KEY=your_api_key
BYBIT_API_SECRET=your_api_secret

# Database
DB_HOST=localhost
DB_PASSWORD=your_password

# AI (опционально)
AI_API_KEY=your_ai_key
AI_BASE_URL=https://api.qwen.ai
```

#### 5. Запуск

```bash
go run cmd/bot/main.go
```

Или соберите бинарник:

```bash
go build -o bot cmd/bot/main.go
./bot
```

📖 Подробная инструкция: [SETUP.md](SETUP.md)

</details>

## 💬 Команды Telegram бота (Production Ready!)

### 📊 Информационные команды

| Команда | Параметры | Описание | Пример |
|---------|-----------|----------|---------|
| `/status` | - | Показывает текущий статус: активные активы, стратегии, автосейл, грид, аптайм | `/status` |
| `/history` | `[SYMBOL] [N]` | История последних N сделок (по умолчанию 10) | `/history BTCUSDT 20` |
| `/config` | - | Текущая конфигурация всех активов и риск-лимитов | `/config` |
| `/price` | `<SYMBOL>` | Текущая цена, средняя цена входа, изменение в % | `/price BTC` |
| `/portfolio` | - | Сводка портфеля: инвестировано, текущая стоимость, P&L, распределение активов | `/portfolio` |
| `/risk` | - | Статус рисков: экспозиция, дневные убытки, лимиты (Admin) | `/risk` |
| `/help` | - | Справка по всем командам | `/help` |

### 💰 Торговые команды

| Команда | Параметры | Описание | Пример |
|---------|-----------|----------|---------|
| `/buy` | `[SYMBOL] [AMOUNT]` | Рыночная покупка на указанную сумму USDT | `/buy BTCUSDT 20` |
| `/sell` | `<PERCENT> [SYMBOL]` | Продать % позиции (1-100%) | `/sell 50 BTC` |

**Валидация:**
- Проверка баланса USDT
- Проверка лимитов (MaxOrderSize, MaxPositionSize)
- Проверка Emergency Stop
- Проверка наличия позиции для продажи

### ⚙️ Auto-Sell команды

| Команда | Параметры | Описание | Пример |
|---------|-----------|----------|---------|
| `/autosellon` | `[SYMBOL]` | Включить Auto-Sell для актива | `/autosellon BTC` |
| `/autoselloff` | `[SYMBOL]` | Выключить Auto-Sell для актива | `/autoselloff BTC` |
| `/autosell` | `[SYMBOL] <TRIGGER_%> <SELL_%>` | Настроить Auto-Sell: триггер и объем продажи | `/autosell BTC 15 50` |

**Пример:** `/autosell BTCUSDT 15 50` = когда прибыль достигнет +15%, продать 50% позиции

### 🔷 Grid Trading команды

| Команда | Параметры | Описание | Пример |
|---------|-----------|----------|---------|
| `/gridinit` | `<SYMBOL> <LEVELS> <SPACING_%> <ORDER_SIZE>` | Инициализировать Grid стратегию | `/gridinit ETHUSDT 10 2.5 100` |
| `/gridstatus` | `<SYMBOL>` | Статус Grid: активные ордера, метрики, P&L | `/gridstatus ETH` |
| `/gridstop` | `<SYMBOL>` | Остановить Grid и отменить все ордера (Admin) | `/gridstop ETH` |

**Пример:** `/gridinit ETHUSDT 10 2.5 100` = 10 уровней с интервалом 2.5%, по 100 USDT на ордер

### 🛡️ Риск-менеджмент (Admin Only)

| Команда | Параметры | Описание | Пример |
|---------|-----------|----------|---------|
| `/risk` | - | Показать текущие лимиты и экспозицию | `/risk` |
| `/panicstop` | `[on\|off]` | Экстренная остановка всей торговли | `/panicstop on` |

### 🧠 AI Natural Language (Естественный язык)

Просто отправьте сообщение на **русском или английском языке**:

**English examples:**
- "Buy 20 USDT worth of BTC"
- "Sell 50% of ETH"
- "Set auto-sell at +15%"
- "Show portfolio"
- "What's the current price of BTC?"
- "Initialize Grid for ETHUSDT with 10 levels"

**Русские примеры:**
- "Купи BTC на 20 USDT"
- "Продай 30% позиции"
- "Установи автопродажу на +15%"
- "Покажи портфель"
- "Какая текущая цена BTC?"
- "Инициализируй сетку для ETHUSDT"

### 🔒 Безопасность и права доступа

**Публичные команды** (доступны всем пользователям):
- Все информационные команды
- `/buy`, `/sell` (с подтверждением)
- `/autosellon`, `/autoselloff`, `/autosell`
- `/gridinit`, `/gridstatus`

**Admin-only команды** (требуют прав администратора):
- `/risk` - просмотр лимитов риска
- `/gridstop` - остановка Grid
- `/panicstop` - экстренная остановка

**Опасные команды** (требуют подтверждения через inline кнопки):
- `/sell` - продажа позиции
- `/gridstop` - остановка Grid
- `/panicstop` - экстренная остановка

**Конфигурация:**
```env
TG_ADMINS=123456789,987654321  # ID администраторов (через запятую)
TG_CHAT_WHITELIST=  # Белый список пользователей (пусто = разрешить всем)
```

### 📝 Примечания по использованию

1. **Символы:** Поддерживаются короткие названия (BTC, ETH) и полные (BTCUSDT, ETHUSDT)
2. **Числа:** Можно использовать точку или запятую как десятичный разделитель (10.5 или 10,5)
3. **Проценты:** Можно указывать со знаком % или без него (50% или 50)
4. **Rate limiting:** Максимум 2 команды в секунду на пользователя
5. **Preview Mode:** Установите `PREVIEW_MODE=true` для тестирования без реального исполнения
6. **Языки:** Автоматическое определение языка или установка через `DEFAULT_LANG=ru` или `DEFAULT_LANG=en`

## ⚙️ Конфигурация стратегий

### DCA параметры

```env
DCA_AMOUNT=10              # Сумма в USDT для каждой покупки
DCA_INTERVAL=24h           # Интервал между покупками (24h, 12h, 1w и т.д.)
```

### Auto-Sell параметры

```env
AUTO_SELL_ENABLED=true                  # Включен ли Auto-Sell
AUTO_SELL_TRIGGER_PERCENT=10            # Процент прибыли для активации
AUTO_SELL_AMOUNT_PERCENT=50             # Процент позиции для продажи
PRICE_CHECK_INTERVAL=5m                 # Интервал проверки цены
```

## 🔒 Безопасность

1. **Никогда** не коммитьте `.env` файл в git
2. Используйте API ключи только с правами на spot trading
3. Установите IP whitelist на Bybit
4. Ограничьте доступ к Telegram боту через `TELEGRAM_CHAT_ID`
5. Используйте отдельные ключи для тестирования

## 📊 База данных

### Таблицы

#### `trades`
Хранит историю всех сделок
- `id`, `symbol`, `side`, `quantity`, `price`, `amount`, `order_id`, `status`, `created_at`

#### `balances`
Текущие балансы по активам
- `id`, `symbol`, `total_quantity`, `available_qty`, `avg_entry_price`, `total_invested`, `total_sold`, `realized_profit`, `updated_at`

#### `config_params`
Динамические параметры конфигурации
- `id`, `key`, `value`, `updated_at`

#### `logs`
Системные события и логи
- `id`, `level`, `message`, `data`, `created_at`

## 🧪 Тестирование

```bash
# Запуск тестов
go test ./...

# С покрытием
go test -cover ./...
```

## 🛠️ Разработка

### Добавление новой стратегии

1. Создайте новый файл в `internal/strategy/`
2. Реализуйте интерфейс стратегии
3. Добавьте в `main.go`
4. Обновите Telegram команды

### Добавление новой биржи

1. Создайте новый файл в `internal/exchange/`
2. Реализуйте методы:
   - `GetPrice()`
   - `GetBalance()`
   - `PlaceOrder()`
3. Обновите конфигурацию

## 📝 TODO / Roadmap

### ✅ Реализовано
- [x] DCA стратегия
- [x] Auto-Sell стратегия
- [x] Bybit Spot API v5 интеграция
- [x] PostgreSQL хранилище
- [x] Telegram бот интерфейс
- [x] AI-ассистент (Qwen/Kimi)
- [x] Docker контейнеризация

### 🔄 В планах
- [ ] Grid стратегия
- [ ] Поддержка нескольких торговых пар одновременно
- [ ] Веб-интерфейс для мониторинга
- [ ] Интеграция с TradingView сигналами
- [ ] Backtesting функционал
- [ ] Telegram inline кнопки для подтверждения
- [ ] Мультиязычность (EN/RU/CN)
- [ ] Kubernetes deployment манифесты
- [ ] Поддержка других бирж (Binance, OKX)
- [ ] Trailing stop-loss
- [ ] Portfolio rebalancing
- [ ] Уведомления через Discord/Slack

## 🤝 Contributing

Приветствуются pull requests! Для больших изменений сначала откройте issue для обсуждения.

## 📄 Лицензия

MIT License

## ⚠️ Disclaimer

Этот бот предоставляется "как есть" без каких-либо гарантий. Торговля криптовалютой сопряжена с рисками. Автор не несет ответственности за финансовые потери.

**Используйте на свой страх и риск!**

## 📞 Поддержка

Если у вас возникли вопросы или проблемы:

1. Проверьте документацию
2. Посмотрите существующие issues
3. Создайте новый issue с подробным описанием проблемы

---

**Создано с ❤️ для автоматизации криптотрейдинга**
# mark
